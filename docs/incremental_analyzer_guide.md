# ğŸ“ˆ å¢é‡åˆ†æå™¨ä½¿ç”¨æŒ‡å—

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å¢é‡åˆ†æå™¨ä¸ºNirvaæœåŠ¡æ·»åŠ äº†å®æ—¶å¤„ç†è½¬å½•å†…å®¹çš„èƒ½åŠ›ï¼Œæ”¯æŒï¼š

- **ğŸ”„ å¢é‡å¤„ç†**: æ¯3-5åˆ†é’Ÿæ¥æ”¶æ–°è½¬å½•å†…å®¹ï¼Œæ™ºèƒ½åˆ¤æ–­äº‹ä»¶è¾¹ç•Œ
- **ğŸ§  æ™ºèƒ½åˆå¹¶**: AIè‡ªåŠ¨åˆ¤æ–­æ–°å†…å®¹æ˜¯å¦ä¸ºç°æœ‰äº‹ä»¶çš„å»¶ç»­
- **ğŸ“Š å®æ—¶æŸ¥è¯¢**: éšæ—¶è·å–æœ€æ–°çš„äº‹ä»¶çŠ¶æ€å’Œåˆ—è¡¨
- **ğŸ’¾ æ— ç¼å­˜å‚¨**: åŸºäºç°æœ‰JournalFileç»“æ„ï¼Œå®Œå…¨å…¼å®¹

## ğŸš€ æ–°å¢APIç«¯ç‚¹

### 1. å¢é‡åˆ†ææ¥å£

**æ¥å£**: `POST /action/analyze/incremental/v1/`

**åŠŸèƒ½**: å¤„ç†æ–°çš„è½¬å½•å†…å®¹ï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯æ–°å¢äº‹ä»¶è¿˜æ˜¯ç°æœ‰äº‹ä»¶çš„å»¶ç»­

**è¯·æ±‚ä½“**:
```json
{
  "time_stamp": "2025-01-18",
  "new_transcript": "åˆšæ‰Markå’ŒHowardä¹Ÿåˆ°äº†å’–å•¡åº—ï¼Œæˆ‘ä»¬å¼€å§‹è®¨è®ºé¡¹ç›®çš„è¿›å±•..."
}
```

**å“åº”**:
```json
{
  "updated_events_count": 1,
  "new_events_count": 0,
  "total_events_count": 2,
  "message": "æˆåŠŸå¤„ç†å¢é‡è½¬å½•ï¼Œæ–°å¢ 0 ä¸ªäº‹ä»¶ï¼Œæ›´æ–° 1 ä¸ªäº‹ä»¶"
}
```

### 2. è·å–äº‹ä»¶åˆ—è¡¨æ¥å£

**æ¥å£**: `POST /action/analyze/events/get/v1/`

**åŠŸèƒ½**: è·å–æŒ‡å®šæ—¥æœŸçš„æ‰€æœ‰äº‹ä»¶åˆ—è¡¨

**è¯·æ±‚ä½“**:
```json
{
  "time_stamp": "2025-01-18"
}
```

**å“åº”**:
```json
{
  "time_stamp": "2025-01-18",
  "events": [
    {
      "event_id": "uuid-1234",
      "event_title": "Coffee shop work session",
      "time_range": "09:00-11:30",
      "location": "Blue Bottle Coffee",
      "activity_type": "work",
      "people_involved": ["Mark Zhang", "Howard Li"],
      "one_sentence_summary": "...",
      // ... å…¶ä»–EventAnalysiså­—æ®µ
    }
  ],
  "total_count": 2,
  "last_updated": "2025-01-18T11:30:00Z"
}
```

## ğŸ§  æ™ºèƒ½åˆ†æé€»è¾‘

### äº‹ä»¶è¾¹ç•Œåˆ¤æ–­

AIä¼šæ ¹æ®ä»¥ä¸‹æ¡ä»¶åˆ¤æ–­æ–°è½¬å½•å†…å®¹æ˜¯æ–°äº‹ä»¶è¿˜æ˜¯ç°æœ‰äº‹ä»¶çš„å»¶ç»­ï¼š

#### ğŸ“ **å»¶ç»­ç°æœ‰äº‹ä»¶** (CONTINUE)
- ç›¸åŒæˆ–ç›¸è¿‘çš„åœ°ç‚¹
- ç›¸ä¼¼çš„æ´»åŠ¨ç±»å‹
- ç›¸åŒçš„å‚ä¸äººå‘˜
- æ—¶é—´ä¸Šè¿ç»­ï¼ˆé€šå¸¸<30åˆ†é’Ÿé—´éš”ï¼‰

#### âœ¨ **åˆ›å»ºæ–°äº‹ä»¶** (NEW)
- æ˜æ˜¾çš„åœ°ç‚¹å˜åŒ–
- æ´»åŠ¨ç±»å‹æ”¹å˜
- å‚ä¸äººå‘˜å˜åŒ–
- è¾ƒé•¿çš„æ—¶é—´é—´éš”

### å¤„ç†æµç¨‹

```mermaid
graph TD
    A[æ¥æ”¶æ–°è½¬å½•] --> B[è·å–ç°æœ‰äº‹ä»¶]
    B --> C{æ˜¯å¦æœ‰ç°æœ‰æ—¥è®°?}
    C -->|å¦| D[åˆ›å»ºåˆå§‹æ—¥è®°]
    C -->|æ˜¯| E[AIåˆ†æå…³ç³»]
    E --> F{ç¬¬ä¸€ä¸ªäº‹ä»¶å…³ç³»?}
    F -->|CONTINUE| G[åˆå¹¶åˆ°ç°æœ‰äº‹ä»¶]
    F -->|NEW| H[åˆ›å»ºæ–°äº‹ä»¶]
    G --> I[æ›´æ–°æ•°æ®åº“]
    H --> I
    D --> I
    I --> J[è¿”å›ç»“æœ]
```

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### Pythonå®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests

BASE_URL = "http://localhost:8000"
AUTH_TOKEN = "your_auth_token"
DATE = "2025-01-18"

def send_incremental_transcript(transcript: str):
    """å‘é€å¢é‡è½¬å½•å†…å®¹"""
    response = requests.post(
        f"{BASE_URL}/action/analyze/incremental/v1/",
        json={
            "time_stamp": DATE,
            "new_transcript": transcript
        },
        headers={"Authorization": f"Bearer {AUTH_TOKEN}"}
    )
    return response.json()

def get_events():
    """è·å–äº‹ä»¶åˆ—è¡¨"""
    response = requests.post(
        f"{BASE_URL}/action/analyze/events/get/v1/",
        json={"time_stamp": DATE},
        headers={"Authorization": f"Bearer {AUTH_TOKEN}"}
    )
    return response.json()

# ç¤ºä¾‹ä½¿ç”¨
if __name__ == "__main__":
    # ç¬¬ä¸€æ¬¡è½¬å½•
    result1 = send_incremental_transcript(
        "ä»Šå¤©æ—©ä¸Š9ç‚¹åˆ°äº†Blue Bottle Coffeeï¼Œå‡†å¤‡å¼€å§‹å·¥ä½œã€‚"
    )
    print(f"ç¬¬ä¸€æ¬¡åˆ†æ: {result1['message']}")
    
    # ç¬¬äºŒæ¬¡è½¬å½•ï¼ˆå»¶ç»­ï¼‰
    result2 = send_incremental_transcript(
        "Markå’ŒHowardä¹Ÿåˆ°äº†ï¼Œæˆ‘ä»¬å¼€å§‹è®¨è®ºé¡¹ç›®è¿›å±•ã€‚"
    )
    print(f"ç¬¬äºŒæ¬¡åˆ†æ: {result2['message']}")
    
    # ç¬¬ä¸‰æ¬¡è½¬å½•ï¼ˆæ–°äº‹ä»¶ï¼‰
    result3 = send_incremental_transcript(
        "ä¼šè®®ç»“æŸäº†ï¼Œæˆ‘ç¦»å¼€å’–å•¡åº—ï¼Œç°åœ¨åœ¨å›å®¶è·¯ä¸Šã€‚"
    )
    print(f"ç¬¬ä¸‰æ¬¡åˆ†æ: {result3['message']}")
    
    # è·å–æ‰€æœ‰äº‹ä»¶
    events = get_events()
    print(f"æ€»å…± {events['total_count']} ä¸ªäº‹ä»¶")
    for event in events['events']:
        print(f"- {event['event_title']} ({event['time_range']})")
```

### å®šæ—¶å¤„ç†ç¤ºä¾‹

```python
import schedule
import time

def process_new_transcripts():
    """å®šæ—¶å¤„ç†æ–°è½¬å½•å†…å®¹"""
    # è¿™é‡Œå¯ä»¥ä»éŸ³é¢‘è½¬å½•æœåŠ¡è·å–æ–°å†…å®¹
    # æˆ–è€…ä»æ¶ˆæ¯é˜Ÿåˆ—è¯»å–
    new_content = get_latest_transcript()  # éœ€è¦å®ç°
    
    if new_content:
        result = send_incremental_transcript(new_content)
        print(f"å¤„ç†ç»“æœ: {result['message']}")

# æ¯3åˆ†é’Ÿå¤„ç†ä¸€æ¬¡
schedule.every(3).minutes.do(process_new_transcripts)

while True:
    schedule.run_pending()
    time.sleep(1)
```

## ğŸ”§ éƒ¨ç½²å’Œé…ç½®

### 1. å¯åŠ¨æœåŠ¡

ç¡®ä¿æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œï¼š

```bash
# æ¿€æ´»ç¯å¢ƒ
conda activate nirva

# å¯åŠ¨AppService (åŒ…å«æ–°çš„å¢é‡åˆ†æAPI)
make run-appservice

# å¯åŠ¨AnalyzeræœåŠ¡ (ç”¨äºAIåˆ†æ)
make run-analyzer

# å¯åŠ¨ChatæœåŠ¡ (å¦‚æœéœ€è¦)
make run-chat
```

### 2. éªŒè¯åŠŸèƒ½

è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
python scripts/test_incremental_analyzer.py
```

### 3. APIæ–‡æ¡£

è®¿é—® `http://localhost:8000/docs` æŸ¥çœ‹å®Œæ•´çš„APIæ–‡æ¡£ï¼Œæ–°å¢çš„ç«¯ç‚¹ä¼šæ˜¾ç¤ºåœ¨æ–‡æ¡£ä¸­ã€‚

## ğŸ“Š æ•°æ®ç»“æ„

### ç°æœ‰å…¼å®¹æ€§

å¢é‡åˆ†æå™¨å®Œå…¨åŸºäºç°æœ‰çš„æ•°æ®ç»“æ„ï¼š

- **JournalFile**: åŒ…å«eventsåˆ—è¡¨å’Œdaily_reflection
- **EventAnalysis**: è¯¦ç»†çš„äº‹ä»¶åˆ†æç»“æœ
- **JournalFileDB**: æ•°æ®åº“å­˜å‚¨ç»“æ„

### æ•°æ®æµ

```
æ–°è½¬å½• â†’ å¢é‡åˆ†æå™¨ â†’ AIåˆ¤æ–­ â†’ æ›´æ–°JournalFile â†’ ä¿å­˜åˆ°DB
   â†“
ClientæŸ¥è¯¢ â†’ ä»DBè¯»å–JournalFile â†’ è¿”å›eventsåˆ—è¡¨
```

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: äº‹ä»¶å»¶ç»­
```
ç°æœ‰: "Coffee shop work session (09:00-10:30)"
æ–°å¢: "Markå’ŒHowardåˆ°äº†ï¼Œæˆ‘ä»¬å¼€å§‹è®¨è®ºé¡¹ç›®"
ç»“æœ: åˆå¹¶åˆ°ç°æœ‰äº‹ä»¶ï¼Œæ›´æ–°å‚ä¸äººå‘˜å’Œå†…å®¹
```

### åœºæ™¯2: æ–°äº‹ä»¶
```
ç°æœ‰: "Coffee shop work session (09:00-10:30)"
æ–°å¢: "ä¼šè®®ç»“æŸï¼Œæˆ‘ç¦»å¼€å’–å•¡åº—å›å®¶"
ç»“æœ: åˆ›å»ºæ–°äº‹ä»¶ "å›å®¶é€”ä¸­"
```

### åœºæ™¯3: é¦–æ¬¡è®°å½•
```
ç°æœ‰: æ— 
æ–°å¢: "ä»Šå¤©æ—©ä¸Šåˆ°äº†å’–å•¡åº—å‡†å¤‡å·¥ä½œ"
ç»“æœ: åˆ›å»ºåˆå§‹æ—¥è®°å’Œç¬¬ä¸€ä¸ªäº‹ä»¶
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ€§èƒ½è€ƒè™‘
- AIåˆ†ææœ‰2åˆ†é’Ÿè¶…æ—¶é™åˆ¶
- å»ºè®®æ¯æ¬¡è½¬å½•å†…å®¹ä¸è¶…è¿‡1000å­—ç¬¦
- å¤§é‡å¹¶å‘è¯·æ±‚å¯èƒ½å½±å“å“åº”æ—¶é—´

### 2. é”™è¯¯å¤„ç†
- AIåˆ†æå¤±è´¥æ—¶ä¼šåˆ›å»ºé»˜è®¤äº‹ä»¶
- ç½‘ç»œé”™è¯¯ä¼šè¿”å›é€‚å½“çš„HTTPçŠ¶æ€ç 
- æ•°æ®åº“é”™è¯¯ä¼šå›æ»šäº‹åŠ¡

### 3. æ•°æ®ä¸€è‡´æ€§
- æ‰€æœ‰æ›´æ–°éƒ½æ˜¯åŸå­æ“ä½œ
- æ”¯æŒå¹¶å‘è®¿é—®
- è‡ªåŠ¨å¤„ç†æ—¶é—´æˆ³å†²çª

## ğŸš€ æœªæ¥æ‰©å±•

### å¯èƒ½çš„å¢å¼ºåŠŸèƒ½
1. **æ‰¹é‡å¤„ç†**: æ”¯æŒä¸€æ¬¡å¤„ç†å¤šæ®µè½¬å½•å†…å®¹
2. **å®æ—¶æ¨é€**: WebSocketæ”¯æŒå®æ—¶äº‹ä»¶æ›´æ–°é€šçŸ¥
3. **æ™ºèƒ½æ‘˜è¦**: è‡ªåŠ¨ç”Ÿæˆäº‹ä»¶æ‘˜è¦å’Œæ ‡ç­¾
4. **æƒ…ç»ªåˆ†æ**: å¢åŠ æƒ…ç»ªçŠ¶æ€çš„å®æ—¶è·Ÿè¸ª
5. **ä¸ªæ€§åŒ–å­¦ä¹ **: åŸºäºç”¨æˆ·å†å²æ•°æ®ä¼˜åŒ–åˆ¤æ–­é€»è¾‘

### é›†æˆå»ºè®®
1. **å‰ç«¯é›†æˆ**: åœ¨UIä¸­æ·»åŠ å®æ—¶äº‹ä»¶æ˜¾ç¤º
2. **ç§»åŠ¨ç«¯**: æ”¯æŒè¯­éŸ³è½¬å½•çš„å®æ—¶ä¸Šä¼ 
3. **ç¬¬ä¸‰æ–¹æœåŠ¡**: é›†æˆæ—¥å†ã€ä½ç½®ç­‰å¤–éƒ¨æ•°æ®æº

---

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜æˆ–éœ€è¦å¸®åŠ©ï¼š

1. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶ä¸­çš„é”™è¯¯ä¿¡æ¯
2. éªŒè¯è®¤è¯tokenæ˜¯å¦æœ‰æ•ˆ
3. ç¡®è®¤æ‰€æœ‰ä¾èµ–æœåŠ¡æ­£å¸¸è¿è¡Œ
4. æŸ¥çœ‹APIæ–‡æ¡£ä¸­çš„è¯¦ç»†å‚æ•°è¯´æ˜

ğŸ‰ **ç°åœ¨ä½ å¯ä»¥äº«å—å®æ—¶çš„ã€æ™ºèƒ½çš„äº‹ä»¶å¤„ç†ä½“éªŒäº†ï¼** 